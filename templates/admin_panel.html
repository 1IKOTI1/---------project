<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—â–∏–π —Å—Ç–∏–ª—å —Å–∞–π—Ç–∞ -->
    <link rel="stylesheet" href="/static/style.css">
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å) -->
    <style>
        /* –≠—Ç–∏ —Å—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ–µ */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ —Å—Ç–∏–ª–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º CSS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: rgba(20, 20, 30, 0.9);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .stat-value {
            font-size: 2.5em;
            color: #00ffff;
            margin: 10px 0;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        
        .stat-label {
            color: #a0a0a0;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            flex: 1;
            min-width: 120px;
            background: rgba(20, 20, 30, 0.8);
            border: 1px solid rgba(0, 255, 255, 0.2);
            color: #ffffff;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            background: rgba(30, 30, 40, 0.9);
            border-color: rgba(0, 255, 255, 0.5);
        }
        
        .tab-btn.active {
            background: rgba(0, 255, 255, 0.15);
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        
        .tab-content {
            display: none;
            background: rgba(20, 20, 30, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .action-btn {
            padding: 5px 10px;
            margin: 2px;
            font-size: 0.9em;
        }
        
        .add-coins-btn {
            background: linear-gradient(135deg, #1a3a1a, #2a4a2a);
        }
        
        .top-users {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .top-user-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

                /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏–∑–æ–≤ */
        #prizesTable {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
        }

        #prizesTable th, #prizesTable td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 8px;
        }

        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ */
        #prizesTable th:nth-child(1) { width: 5%; }   /* ID */
        #prizesTable th:nth-child(2) { width: 20%; }  /* –ù–∞–∑–≤–∞–Ω–∏–µ */
        #prizesTable th:nth-child(3) { width: 15%; }  /* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
        #prizesTable th:nth-child(4) { width: 30%; }  /* –û–ø–∏—Å–∞–Ω–∏–µ */
        #prizesTable th:nth-child(5) { width: 10%; }  /* –î–æ—Å—Ç—É–ø–µ–Ω */
        #prizesTable th:nth-child(6) { width: 20%; }  /* –î–∞—Ç–∞ */

        /* –•–æ–≤–µ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
        #prizesTable td:hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            background: rgba(0, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container admin-container">
        <div class="header">
            <h1>‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <a href="/admin/logout" class="logout-btn">üö™ –í—ã–π—Ç–∏</a>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">-</div>
                <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCoins">-</div>
                <div class="stat-label">–í—Å–µ–≥–æ –º–æ–Ω–µ—Ç</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="availablePrizes">-</div>
                <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω–æ –ø—Ä–∏–∑–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalWinners">-</div>
                <div class="stat-label">–ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</div>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="tab-btn" onclick="switchTab('prizes')">üéÅ –ü—Ä–∏–∑—ã</button>
            <button class="tab-btn" onclick="switchTab('winners')">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏</button>
             <button class="tab-btn" onclick="switchTab('coins')">üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç–∞–º–∏</button>
            <button class="tab-btn" onclick="switchTab('add_prize')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑</button>
            <button class="tab-btn" onclick="switchTab('transactions')">üìä –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <div id="tab-users" class="tab-content active">
            <h2>üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
            <div class="top-users" id="topUsers"></div>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–∏–∫–Ω–µ–π–º</th>
                        <th>Telegram</th>
                        <th>–°—Å—ã–ª–∫–∞</th>
                        <th>–ú–æ–Ω–µ—Ç—ã</th>
                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr><td colspan="8" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞: –ü—Ä–∏–∑—ã -->
        <div id="tab-prizes" class="tab-content">
            <h2>üéÅ –í—Å–µ –ø—Ä–∏–∑—ã</h2>
            <table id="prizesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–î–æ—Å—Ç—É–ø–µ–Ω</th>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    </tr>
                </thead>
                <tbody id="prizesTableBody">
                    <tr><td colspan="6" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞: –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ (–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) -->
        <div id="tab-winners" class="tab-content">
            <h2>üèÜ –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</h2>
            <table id="winnersTable">
                <thead>
                    <tr>
                        <th>–ù–∏–∫–Ω–µ–π–º</th>
                        <th>Telegram</th>
                        <th>–°—Å—ã–ª–∫–∞</th>
                        <th>–ü—Ä–∏–∑</th>
                        <th>–î–∞—Ç–∞</th>
                    </tr>
                </thead>
                <tbody id="winnersTableBody">
                    <tr><td colspan="5" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
                <!-- –í–∫–ª–∞–¥–∫–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç–∞–º–∏ -->
        <div id="tab-coins" class="tab-content">
            <div class="form-section">
                <h2>üí∞ –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã</h2>
                
                <div class="form-group">
                    <label for="coinNickname">–ù–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="coinNickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º">
                </div>
                
                <div class="form-group">
                    <label for="coinAmount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç (–º–∞–∫—Å. 10 000)</label>
                    <input type="number" id="coinAmount" value="10" min="1" max="10000">
                </div>
                
                <div class="form-group">
                    <label for="coinReason">–ü—Ä–∏—á–∏–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" id="coinReason" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–æ–Ω—É—Å –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å">
                </div>
                
                <button onclick="addCoins()" class="register-btn" style="background: linear-gradient(135deg, #1a3a1a, #2a4a2a);">üíé –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã</button>
            </div>
            
            <div class="form-section" style="margin-top: 20px;">
                <h2>üí∏ –°–Ω—è—Ç—å –º–æ–Ω–µ—Ç—ã</h2>
                
                <div class="form-group">
                    <label for="removeCoinNickname">–ù–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="removeCoinNickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º">
                </div>
                
                <div class="form-group">
                    <label for="removeCoinAmount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç (–º–∞–∫—Å. 10 000)</label>
                    <input type="number" id="removeCoinAmount" value="10" min="1" max="10000">
                </div>
                
                <div class="form-group">
                    <label for="removeCoinReason">–ü—Ä–∏—á–∏–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" id="removeCoinReason" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —à—Ç—Ä–∞—Ñ">
                </div>
                
                <button onclick="removeCoins()" class="register-btn" style="background: linear-gradient(135deg, #3a1a1a, #4a2a2a);">üí∏ –°–Ω—è—Ç—å –º–æ–Ω–µ—Ç—ã</button>
            </div>
        </div>
        
        
        <!-- –í–∫–ª–∞–¥–∫–∞: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑ -->
        <div id="tab-add_prize" class="tab-content">
            <div class="form-section">
                <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–∏–∑</h2>
                
                <div class="form-group">
                    <label for="prizeName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞</label>
                    <input type="text" id="prizeName" 
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–µ–Ω–µ–≤–∞—è –∫–∞—Ä—Ç–∞ #6" 
                        maxlength="30">
                </div>
                
                    <div class="form-group">
                    <label for="prizeImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–∑–∞</label>
                    <input type="file" id="prizeImage" accept="image/png, image/jpeg, image/webp, image/gif">
                    <small>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PNG, JPG, WEBP, GIF (–º–∞–∫—Å. 2MB)</small>
                    <div id="imagePreview" style="margin-top: 10px; max-width: 200px; display: none;">
                            <img src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" style="width: 100%; border-radius: 5px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="prizeDescription">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="prizeDescription" 
                            rows="3" 
                            maxlength="500"
                            placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–∑–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)"
                            oninput="updateDescCounter()"></textarea>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <small id="descCounter" class="char-counter">0/500</small>
                        <small id="descWarning" style="color: #ffaa00; display: none;">‚ö†Ô∏è –û—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ –º–µ—Å—Ç–∞</small>
                    </div>
                </div>
                
                <button onclick="addPrize()" class="register-btn" id="addPrizeBtn">‚ú® –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑</button>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
        <div id="tab-transactions" class="tab-content">
            <h2>üìä –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h2>
            <table id="transactionsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                        <th>–î–∞—Ç–∞</th>
                    </tr>
                </thead>
                <tbody id="transactionsTableBody">
                    <tr><td colspan="5" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="message" style="display: none;"></div>
    
    <script>
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            loadTabData(tabName);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
        function loadTabData(tabName) {
            switch(tabName) {
                case 'users':
                    loadUsers();
                    break;
                case 'prizes':
                    loadPrizes();
                    break;
                case 'winners':
                    loadWinners();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'coins':
                    break;    
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = `message message-${type}`;
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 3000);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalUsers').textContent = data.stats.total_users;
                    document.getElementById('totalCoins').textContent = data.stats.total_coins;
                    document.getElementById('availablePrizes').textContent = data.stats.available_prizes;
                    document.getElementById('totalWinners').textContent = data.stats.total_winners;
                    
                    // –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    const topUsers = data.stats.top_users;
                    if (topUsers && topUsers.length > 0) {
                        document.getElementById('topUsers').innerHTML = `
                            <h3>üèÜ –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –º–æ–Ω–µ—Ç–∞–º</h3>
                            ${topUsers.map(u => `
                                <div class="top-user-item">
                                    <span>${u.nickname}</span>
                                    <span style="color: #00ffff;">${u.coins} –º–æ–Ω–µ—Ç</span>
                                </div>
                            `).join('')}
                        `;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
            
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                if (data.success && data.users.length > 0) {
                    tbody.innerHTML = data.users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.nickname}</td>
                            <td>${user.telegram || '-'}</td>
                            <td>${user.site_url ? `<a href="${user.site_url}" target="_blank">—Å—Å—ã–ª–∫–∞</a>` : '-'}</td>
                            <td style="color: #00ffff; font-weight: bold;">${user.shadow_coins}</td>
                            <td>${new Date(user.created_at).toLocaleString()}</td>
                            <td>${new Date(user.last_login).toLocaleString()}</td>
                            <td>
                                <button class="action-btn add-coins-btn" onclick="quickAddCoins('${user.nickname}')">+üí∞</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
            }
        }
        
        // –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç
        function quickAddCoins(nickname) {
            document.getElementById('coinNickname').value = nickname;
            document.getElementById('coinAmount').value = 10;
            switchTab('coins');  // –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –í–ö–õ–ê–î–ö–ê
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç
        async function addCoins() {
            const nickname = document.getElementById('coinNickname').value.trim();
            const amount = parseInt(document.getElementById('coinAmount').value);
            const reason = document.getElementById('coinReason').value.trim();
            
            if (!nickname) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            if (!amount || amount < 1) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/add_coins', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nickname: nickname,
                        amount: amount,
                        reason: reason
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.getElementById('coinNickname').value = '';
                    document.getElementById('coinAmount').value = '10';
                    document.getElementById('coinReason').value = '';
                    loadStats();
                    loadUsers();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        // –°–Ω—è—Ç–∏–µ –º–æ–Ω–µ—Ç
async function removeCoins() {
    const nickname = document.getElementById('removeCoinNickname').value.trim();
    const amount = parseInt(document.getElementById('removeCoinAmount').value);
    const reason = document.getElementById('removeCoinReason').value.trim();
    
    if (!nickname) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        return;
    }
    
    if (!amount || amount < 1) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    if (amount > 10000) {
        showMessage('–ù–µ–ª—å–∑—è —Å–Ω—è—Ç—å –±–æ–ª—å—à–µ 10000 –º–æ–Ω–µ—Ç –∑–∞ —Ä–∞–∑', 'error');
        return;
    }
    
    try {
            const response = await fetch('/api/admin/remove_coins', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nickname: nickname,
                    amount: amount,
                    reason: reason
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(data.message, 'success');
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('removeCoinNickname').value = '';
                document.getElementById('removeCoinAmount').value = '10';
                document.getElementById('removeCoinReason').value = '';
                loadStats();
                loadUsers();
            } else {
                showMessage(data.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
        }
    }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–∑–æ–≤
        async function loadPrizes() {
            const tbody = document.getElementById('prizesTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
            
            try {
                const response = await fetch('/api/admin/prizes');
                const data = await response.json();
                
                if (data.success && data.prizes.length > 0) {
                    tbody.innerHTML = data.prizes.map(prize => `
                        <tr>
                            <td>${prize.id}</td>
                            <td title="${prize.name}">${prize.name}</td>
                            <td title="${prize.image}">${prize.image}</td>
                            <td title="${prize.description || ''}">${(prize.description || '').substring(0, 30)}${prize.description && prize.description.length > 30 ? '...' : ''}</td>
                            <td style="color: ${prize.available ? '#00ff00' : '#ff4444'}">
                                ${prize.available ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –†–∞–∑—ã–≥—Ä–∞–Ω'}
                            </td>
                            <td>${new Date(prize.created_at).toLocaleString()}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">–ù–µ—Ç –ø—Ä–∏–∑–æ–≤</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
        async function loadWinners() {
            const tbody = document.getElementById('winnersTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
            
            try {
                const response = await fetch('/api/admin/winners');
                const data = await response.json();
                
                if (data.success && data.winners.length > 0) {
                    tbody.innerHTML = data.winners.map(w => `
                        <tr>
                            <td>${w.nickname}</td>
                            <td>${w.telegram || '-'}</td>
                            <td>${w.site_url ? `<a href="${w.site_url}" target="_blank">—Å—Å—ã–ª–∫–∞</a>` : '-'}</td>
                            <td>${w.prize_name}</td>
                            <td>${new Date(w.won_at).toLocaleString()}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        async function loadTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
            
            try {
                const response = await fetch('/api/admin/transactions');
                const data = await response.json();
                
                if (data.success && data.transactions.length > 0) {
                    tbody.innerHTML = data.transactions.map(t => `
                        <tr>
                            <td>${t.id}</td>
                            <td>User #${t.user_id}</td>
                            <td style="color: ${t.amount > 0 ? '#00ff00' : '#ff4444'}; font-weight: bold;">
                                ${t.amount > 0 ? '+' : ''}${t.amount}
                            </td>
                            <td>${t.reason || '-'}</td>
                            <td>${new Date(t.created_at).toLocaleString()}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è
        function updateDescCounter() {
            const textarea = document.getElementById('prizeDescription');
            const counter = document.getElementById('descCounter');
            const warning = document.getElementById('descWarning');
            const addBtn = document.getElementById('addPrizeBtn');
            
            if (!textarea || !counter) return;
            
            const currentLength = textarea.value.length;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—á–µ—Ç—á–∏–∫–∞
            counter.textContent = `${currentLength}/500`;
            
            // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã
            if (currentLength > 500) {
                counter.style.color = '#ff4444';
                counter.classList.add('danger');
                if (warning) {
                    warning.style.display = 'inline';
                    warning.textContent = '‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç!';
                    warning.style.color = '#ff4444';
                }
                if (addBtn) addBtn.disabled = true;
            } else if (currentLength > 450) {
                counter.style.color = '#ffaa00';
                counter.classList.add('warning');
                if (warning) {
                    warning.style.display = 'inline';
                    warning.textContent = '‚ö†Ô∏è –û—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ –º–µ—Å—Ç–∞';
                    warning.style.color = '#ffaa00';
                }
                if (addBtn) addBtn.disabled = false;
            } else {
                counter.style.color = '#8080a0';
                counter.classList.remove('warning', 'danger');
                if (warning) warning.style.display = 'none';
                if (addBtn) addBtn.disabled = false;
            }
        }
        
       // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        async function addPrize() {
            const name = document.getElementById('prizeName').value.trim();
            const imageFile = document.getElementById('prizeImage').files[0];
            const description = document.getElementById('prizeDescription').value.trim();
            
            if (!name) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞', 'error');
                return;
            }
            
            if (!imageFile) {
                showMessage('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –æ–ø–∏—Å–∞–Ω–∏—è
            if (description.length > 500) {
                showMessage(`–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (${description.length}/500)`, 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
            const formData = new FormData();
            formData.append('name', name);
            formData.append('image', imageFile);
            formData.append('description', description);
            
            try {
                const response = await fetch('/api/admin/add_prize', {
                    method: 'POST',
                    body: formData  // –ù–µ —É–∫–∞–∑—ã–≤–∞–µ–º Content-Type, –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –¥–æ–±–∞–≤–∏—Ç multipart/form-data
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('–ü—Ä–∏–∑ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('prizeName').value = '';
                    document.getElementById('prizeImage').value = '';
                    document.getElementById('prizeDescription').value = '';
                    document.getElementById('imagePreview').style.display = 'none';
                    updateDescCounter();
                    loadPrizes();
                    loadStats();
                } else {
                    showMessage(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–∑–∞', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadUsers();
            loadPrizes();
            loadWinners();
            loadTransactions();

            updateDescCounter();
    
            const descTextarea = document.getElementById('prizeDescription');
            if (descTextarea) {
                descTextarea.addEventListener('input', updateDescCounter);
            }

            
        });

        document.getElementById('prizeImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            const previewImg = preview.querySelector('img');
            
            if (file) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showMessage('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 2MB)', 'error');
                    this.value = '';
                    preview.style.display = 'none';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });
    </script>
</body>
</html>